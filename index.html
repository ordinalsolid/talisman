<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Geological Glyph Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: #000;
  color: #eee;
  font-family: system-ui, sans-serif;
}

.container {
  max-width: 1500px;
  margin: auto;
  padding: 20px;
  display: flex;
  gap: 20px;
}

.sidebar {
  width: 320px;
  background: #111;
  border-radius: 14px;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.sidebar button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  background: #333;
  color: #eee;
  cursor: pointer;
}

.assets {
  flex: 1;
  overflow-y: auto;
}

.assets-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.asset {
  aspect-ratio: 1;
  background: #222;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid transparent;
}

.asset.selected {
  border-color: #aaa;
}

.asset img {
  width: 85%;
  height: 85%;
  object-fit: contain;
  pointer-events: none;
}

.canvas-wrap {
  flex: 1;
  display: flex;
  justify-content: center;
}

canvas {
  background: #000;
  border-radius: 18px;
}
</style>
</head>

<body>
<div class="container">

  <div class="sidebar">
    <button onclick="generate()">Regenerate Stone</button>
    <button onclick="clearAssets()">Clear Assets</button>

    <div class="assets">
      <div class="assets-grid" id="assetGrid"></div>
    </div>
  </div>

  <div class="canvas-wrap">
    <canvas id="canvas" width="720" height="1080"></canvas>
  </div>

</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let cavities = [];
let outline = [];
let placedAssets = {};
let hovered = null;
let selectedAsset = null;

const assetPaths = [
  "Spec_Geo_Assets/sg_0001.png",
  "Spec_Geo_Assets/sg_0008b.png",
  "Spec_Geo_Assets/sg_0023c.png",
  "Spec_Geo_Assets/sg_0047a.png",
  "Spec_Geo_Assets/sg_0055d.png",
  "Spec_Geo_Assets/sg_0056b.png",
  "Spec_Geo_Assets/sg_0058d.png",
  "Spec_Geo_Assets/sg_0063a.png",
  "Spec_Geo_Assets/sg_0067.png",
  "Spec_Geo_Assets/sg_0070.png",
  "Spec_Geo_Assets/sg_0072.png",
  "Spec_Geo_Assets/sg_0078a.png"
	"Spec_Geo_Assets/sg_0078f.png"
	"Spec_Geo_Assets/sg_0080b.png"
	"Spec_Geo_Assets/sg_0080c.png"
	"Spec_Geo_Assets/sg_0085a.png"
	"Spec_Geo_Assets/sg_0086a.png"
	"Spec_Geo_Assets/sg_0096a.png"
	"Spec_Geo_Assets/sg_0096h.png"
	"Spec_Geo_Assets/sg_0097b.png"
	"Spec_Geo_Assets/sg_0104c.png"
	"Spec_Geo_Assets/sg_0104g.png"
	"Spec_Geo_Assets/sg_0148.png"
	"Spec_Geo_Assets/sg_0191.png"
];

const imgCache = {};
function loadImg(src) {
  if (imgCache[src]) return imgCache[src];
  const i = new Image();
  i.src = src;
  imgCache[src] = i;
  return i;
}

/* ---------- UI ---------- */
const grid = document.getElementById("assetGrid");
assetPaths.forEach(src => {
  const d = document.createElement("div");
  d.className = "asset";
  d.innerHTML = `<img src="${src}">`;
  d.onclick = () => {
    document.querySelectorAll(".asset").forEach(a => a.classList.remove("selected"));
    d.classList.add("selected");
    selectedAsset = src;
  };
  grid.appendChild(d);
});

/* ---------- GEOMETRY ---------- */
function dist(a,b){return Math.hypot(a.x-b.x,a.y-b.y)}

function organic(cx,cy,r,n=40){
  const pts=[];
  for(let i=0;i<n;i++){
    const a=i/n*Math.PI*2;
    const e=r*(0.6+Math.random()*0.6);
    pts.push({x:cx+Math.cos(a)*e,y:cy+Math.sin(a)*e});
  }
  return pts;
}

function drawPath(p){
  ctx.beginPath();
  ctx.moveTo(p[0].x,p[0].y);
  p.forEach(pt=>ctx.lineTo(pt.x,pt.y));
  ctx.closePath();
}

function inside(x,y,p){
  let c=false;
  for(let i=0,j=p.length-1;i<p.length;j=i++){
    ((p[i].y>y)!==(p[j].y>y)) &&
    x<(p[j].x-p[i].x)*(y-p[i].y)/(p[j].y-p[i].y)+p[i].x &&
    (c=!c);
  }
  return c;
}

/* ---------- GENERATION ---------- */
function generate(){
  cavities=[];
  placedAssets={};

  const count=6+Math.floor(Math.random()*5);
  let id=0;

let attempts = 0;
const maxAttempts = 500;

while (cavities.length < count && attempts < maxAttempts) {
  attempts++;

  const r = 85 + Math.random() * 55;
  const c = {
    id: id++,
    x: canvas.width / 2 + (Math.random() - 0.5) * 340,
    y: canvas.height / 2 + (Math.random() - 0.5) * 520,
    r
  };

  if (cavities.every(o => dist(c, o) > c.r + o.r + 40)) {
    c.shape = organic(c.x, c.y, c.r);
    cavities.push(c);
  }
}


  buildOutline();
  draw();
}

function buildOutline(){
  outline=[];
  const cx=canvas.width/2;
  const cy=canvas.height/2;

  const steps=180;
  for(let i=0;i<steps;i++){
    const a=i/steps*Math.PI*2;
    let d=0;

    cavities.forEach(c=>{
      const dx=Math.cos(a)*(c.x-cx)+Math.sin(a)*(c.y-cy);
      const influence=Math.max(0,c.r*2.2-dx);
      d+=influence;
    });

    d=210+d*0.5+Math.random()*30;
    outline.push({
      x:cx+Math.cos(a)*d,
      y:cy+Math.sin(a)*d
    });
  }
}

/* ---------- ROCK TEXTURE ---------- */
function rockFill(){
  // Base value gradient (light from above)
  const base=ctx.createLinearGradient(0,0,0,canvas.height);
  base.addColorStop(0,"#666");
  base.addColorStop(1,"#121212");
  ctx.fillStyle=base;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Sedimentary banding
  ctx.globalCompositeOperation="multiply";
  for(let y=0;y<canvas.height;y+=4){
    ctx.fillStyle=`rgba(0,0,0,${0.04+Math.random()*0.06})`;
    ctx.fillRect(0,y,canvas.width,2+Math.random()*2);
  }

  // Fracture noise (mid-frequency)
  for(let i=0;i<25000;i++){
    ctx.fillStyle=`rgba(${90+Math.random()*40},${90+Math.random()*40},${90+Math.random()*40},0.08)`;
    ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,2,2);
  }

  // Surface grit (high-frequency)
  ctx.globalCompositeOperation="overlay";
  for(let i=0;i<60000;i++){
    const v=60+Math.random()*80;
    ctx.fillStyle=`rgba(${v},${v},${v},0.06)`;
    ctx.fillRect(Math.random()*canvas.width,Math.random()*canvas.height,1,1);
  }

  ctx.globalCompositeOperation="source-over";
}

/* ---------- DRAW ---------- */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  drawPath(outline);
  ctx.save();
  ctx.clip();
  rockFill();
  ctx.restore();

  cavities.forEach(c=>{
    drawPath(c.shape);
    ctx.fillStyle="#050505";
    ctx.fill();

    const g=ctx.createRadialGradient(
      c.x,
      c.y-c.r*0.4,
      c.r*0.3,
      c.x,
      c.y,
      c.r
    );
    g.addColorStop(0,"rgba(255,255,255,0.18)");
    g.addColorStop(1,"rgba(0,0,0,0.85)");
    ctx.fillStyle=g;
    ctx.fill();

    if(c===hovered){
      ctx.strokeStyle="rgba(255,255,255,0.35)";
      ctx.lineWidth=2;
      ctx.stroke();
    }

    const p=placedAssets[c.id];
    if(p){
      const img=loadImg(p.src);
      const size=c.r*2*(1.2-p.depth*0.3);
      ctx.save();
      ctx.translate(c.x,c.y);
      ctx.shadowColor="rgba(0,0,0,0.9)";
      ctx.shadowBlur=35*p.depth;
      ctx.shadowOffsetY=18*p.depth;
      ctx.drawImage(img,-size/2,-size/2,size,size);
      ctx.restore();
    }
  });
}

/* ---------- INTERACTION ---------- */
canvas.onmousemove=e=>{
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;
  hovered=cavities.find(c=>inside(x,y,c.shape))||null;
  draw();
};

canvas.onclick=e=>{
  if(!selectedAsset||!hovered)return;
  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left;
  const y=e.clientY-r.top;
  const d=Math.hypot(x-hovered.x,y-hovered.y);
  placedAssets[hovered.id]={src:selectedAsset,depth:Math.min(1,d/hovered.r)};
  draw();
};

function clearAssets(){
  placedAssets={};
  draw();
}

generate();
</script>
</body>
</html>

